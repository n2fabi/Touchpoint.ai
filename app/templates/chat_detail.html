<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with {{ contact }} | Touchpoint.ai</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- QuillJS Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Touchpoint.ai Logo" height="50">
        </div>
        <div class="user-icon">üìß</div>
    </header>

    <nav class="sidebar">
        <a href="{{ url_for('index.index') }}">Home</a>
        <a href="{{ url_for('emails.list_emails') }}">
            E-Mails{% if sidebar_unread > 0 %} <span class="badge">{{ sidebar_unread }}</span>{% endif %}
        </a>
        <a href="{{ url_for('reminders.list_reminders') }}">
            Reminder{% if sidebar_reminder > 0 %} <span class="badge">{{ sidebar_reminder }}</span>{% endif %}
        </a>
        <a href="{{ url_for('chats.list_chats') }}">Chats</a>
        <a href="{{ url_for('customers.list_customers') }}">Customer</a>
        <a href="{{ url_for('products.index') }}">Products</a>
        <a href="{{ url_for('settings.index') }}">Settings</a>
    </nav>

    <main class="main chat-main" style="display: flex;">
        <!-- Linke Chat-Liste -->
        <aside class="chat-list-sidebar">
            <h2>Chats</h2>
            <div class="chat-list-scroll">
                {% for chat in chats |reverse %}
                    <a href="{{ url_for('chats.view_chat', contact_email=chat.email) }}"
                       class="chat-list-item {% if chat.email == contact %}active{% endif %}">
                        <div class="chat-list-name">{{ chat.name }}</div>
                        <div class="chat-list-email">{{ chat.email }}</div>
                    </a>
                {% endfor %}
            </div>
        </aside>

        <!-- Chat-Fenster -->
        <section style="flex: 1;">
            <h2>Chat with {{ contact }}</h2>

            <!-- Scrollbarer Chat -->
            <div class="chat-window" id="chat-window">
                {% for msg in messages %}
                    <div class="chat-bubble {{ msg.direction }}">
                        <a href="{{ url_for('emails.view_email', email_id=msg.id) }}" class="email-link">
                            {{ msg.summary }}
                        </a>
                    </div>
                {% endfor %}
            </div>

            <!-- Textfeld + Button -->
            <form method="POST" class="chat-input-container">
                <textarea name="message" placeholder="Type your message...">{{ message_text }}</textarea>
                <!-- Hidden field: ID der letzten E-Mail -->
                <input type="hidden" name="email_id" value="{{ messages[-1].id }}">
                <button type="submit" name="action" value="generate_email" class="ask-btn">
                    Answer this E-Mail
                </button>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="checkbox" name="use_rag" value="1">
                    Use RAG
                </label>
            </form>
            <!-- Response Box unterhalb der E-Mail -->
            <div class="response-box" >
                {% if answer %}
                    <div class="email-preview email-wide" id="generated-preview">
                        <div class="email-header">
                            <div><strong>To:</strong> {{ answer.to }}</div>
                            <div><strong>Subject:</strong> {{ answer.subject }}</div>
                        </div>
                        <div class="email-body">
                            {{ answer.body_html | safe }}
                        </div>
                    </div>

                    <!-- Hidden edit form -->
                    <form method="POST" id="edit-form" class="ask-ai-container"
                          style="display:none; margin-top:1rem;" enctype="multipart/form-data">
                        <div class="form-row">
                        <label>From:</label>
                        <input type="email" name="from" value="{{ answer.from or 'janedoefenschmirtz@gmail.com' }}" required>
                        </div>
                        
                        <!-- Empf√§nger -->
                        <div class="form-row">
                            <label>To:</label>
                            <input type="email" name="to" value="{{ answer.to or contact }}" required>
                            <span id="toggle-cc-bcc" class="toggle-link">+Cc / Bcc</span>
                        </div>

                        <!-- CC / BCC ausklappbar -->
                        <div id="cc-bcc-row" style="display:none;">
                            <div class="form-row">
                                <label>Cc:</label>
                                <input type="email" name="cc" placeholder="optional">
                            </div>
                            <div class="form-row">
                                <label>Bcc:</label>
                                <input type="email" name="bcc" placeholder="optional">
                            </div>
                        </div>

                        <!-- Betreff -->
                        <div class="form-row">
                            <label>Subject:</label>
                            <input type="text" name="subject" value="{{ answer.subject }}" required>
                        </div>

                        <!-- Body mit WYSIWYG Editor -->
                        <div id="editor">{{ answer.body_html|safe }}</div>

                        <!-- Attachments -->
                        <div class="form-row">
                            <input type="file" name="attachments" multiple>
                        </div>

                        <!-- Hidden Email-ID -->
                        <input type="hidden" name="email_id" value="{{ messages[-1].id }}">

                        <!-- Save Button -->
                        <button type="submit" name="action" value="rewrite_email" class="ask-btn">
                            üíæ Save Draft
                        </button>
                        <button type="submit" name="action" value="rewrite_email" class="ask-btn">
                            ‚ú® Correct & Rewrite
                        </button>
                        <button type="submit" name="action" value="make_friendly" class="ask-btn">
                            ‚ú® Friendly & Warm
                        </button>
                        <button type="submit" name="action" value="make_professional" class="ask-btn">
                            ‚ú® Professional & Formal
                        </button>
                    </form>

                    <!-- Action Buttons -->
                    <div class="email-actions" style="margin-top:0.5rem;">
                        <button type="button" id="edit-btn" class="ask-btn">‚úè Edit</button>
                        <form method="POST" style="display:inline;">
                            <input type="hidden" name="email_id" value="{{ messages[-1].id }}">
                            <button type="submit" name="action" value="send_email" class="ask-btn">
                                üì§ Send
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </section>
    </main>

    <!-- Auto-scroll nach unten -->
    <script>
        const chatWindow = document.getElementById('chat-window');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    </script>

    <script>
        // toggle between preview and edit mode
        document.addEventListener("DOMContentLoaded", () => {
            const editBtn = document.getElementById("edit-btn");
            const preview = document.getElementById("generated-preview");
            const editForm = document.getElementById("edit-form");

            if(editBtn){
                editBtn.addEventListener("click", () => {
                    preview.style.display = "none";
                    editForm.style.display = "block";
                });
            }
        });
    </script>
</body>
</html>
